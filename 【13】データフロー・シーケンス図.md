システムの動作を視覚的に理解できるよう、詳細なフロー図を提供します。
# データフロー・シーケンス図集

## 1. 全体データフロー

### システム全体の情報の流れ

```
┌─────────────────────────────────────────────────────────────┐
│                        INPUT SOURCES                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │   PUB    │  │   EXT    │  │   INT    │  │   CONF   │   │
│  │ 公式Web  │  │Crunchbase│  │面談記録  │  │Term Sheet│   │
│  │プレス    │  │Similarweb│  │質問票    │  │財務Model │   │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘   │
│       │             │             │             │          │
└───────┼─────────────┼─────────────┼─────────────┼──────────┘
        │             │             │             │
        └─────────────┴─────────────┴─────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │    DATA COLLECTION & NORMALIZATION    │
        ├───────────────────────────────────────┤
        │                                        │
        │  1. Web Scraping / API Calls          │
        │  2. LLM Extraction                    │
        │  3. Data Normalization                │
        │  4. Conflict Detection                │
        │                                        │
        │  Output: Observations Table            │
        └───────────────┬───────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────────────┐
        │         OBSERVATION STORAGE            │
        ├───────────────────────────────────────┤
        │                                        │
        │  ┌──────────────────────────────┐     │
        │  │   PostgreSQL: Observations   │     │
        │  │                              │     │
        │  │  case_id | section | field  │     │
        │  │  value | source | evidence   │     │
        │  │  confidence | as_of          │     │
        │  └──────────────────────────────┘     │
        │                                        │
        └───────────────┬───────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────────────┐
        │      ANALYSIS & CALCULATION            │
        ├───────────────────────────────────────┤
        │                                        │
        │  1. Unit Economics (LTV/CAC)          │
        │  2. Market Size (TAM/SAM/SOM)         │
        │  3. Valuation (Comps, DCF)            │
        │  4. Scenario Analysis                  │
        │                                        │
        │  Output: Calculations Table            │
        └───────────────┬───────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────────────┐
        │         REPORT GENERATION              │
        ├───────────────────────────────────────┤
        │                                        │
        │  1. Section Assembly                   │
        │  2. LLM Writing                        │
        │  3. Citation Injection                 │
        │  4. IC / LP Version Rendering          │
        │                                        │
        │  Output: Markdown / Google Docs        │
        └───────────────┬───────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────────────┐
        │            OUTPUT                      │
        ├───────────────────────────────────────┤
        │                                        │
        │  📄 IC資料 (完全版)                    │
        │  📄 LP資料 (マスク版)                  │
        │  📊 ダッシュボード                     │
        │                                        │
        └───────────────────────────────────────┘
```

---

## 2. Phase別の詳細フロー

### Phase 1: PUB収集フロー

```
┌──────────────────────────────────────────────────────────┐
│ USER: 新規案件作成 + WebサイトURL入力                    │
└────────────┬─────────────────────────────────────────────┘
             │
             ▼
┌────────────────────────────────────────────────────────┐
│ SYSTEM: Workflow開始                                    │
│   - Status: "PUB収集中"                                │
│   - ワークフローステージテーブル更新                    │
└────────────┬───────────────────────────────────────────┘
             │
             ▼
┌────────────────────────────────────────────────────────┐
│ PUB COLLECTOR BOT                                       │
├────────────────────────────────────────────────────────┤
│                                                        │
│  Step 1: Webページ取得                                 │
│    ├─ Playwright起動                                   │
│    ├─ JavaScript実行を待機                             │
│    ├─ HTML取得                                         │
│    └─ スクリーンショット保存（証拠）                   │
│                                                        │
│  Step 2: HTML クリーニング                             │
│    ├─ BeautifulSoupでパース                            │
│    ├─ 不要タグ削除 (script, style, nav)               │
│    ├─ テキスト抽出                                     │
│    └─ トークン数確認 (< 4000)                         │
│                                                        │
│  Step 3: LLM抽出                                       │
│    ├─ OpenAI API呼び出し                               │
│    │   Model: gpt-4o                                  │
│    │   Format: JSON                                   │
│    │   Temperature: 0.1                               │
│    ├─ 抽出結果の検証                                   │
│    │   - 必須フィールドチェック                        │
│    │   - フォーマット検証                              │
│    │   - 信頼度チェック                                │
│    └─ リトライ（失敗時、最大3回）                      │
│                                                        │
│  Step 4: 観測データ変換                                │
│    ├─ 各フィールドを観測レコードに                     │
│    ├─ source_tag = "PUB"                              │
│    ├─ evidence = URL                                  │
│    └─ as_of = 現在日時                                │
│                                                        │
│  Step 5: データベース保存                              │
│    ├─ トランザクション開始                             │
│    ├─ 観測データ一括挿入                               │
│    ├─ ワークフローステージ更新                         │
│    └─ コミット                                         │
│                                                        │
│  Step 6: 通知                                          │
│    ├─ WebSocket経由でUI更新                            │
│    ├─ 担当者にSlack通知                                │
│    └─ 監査ログ記録                                     │
│                                                        │
└────────────┬───────────────────────────────────────────┘
             │
             ▼
┌────────────────────────────────────────────────────────┐
│ USER: 抽出結果を確認                                    │
│   - データの確認                                        │
│   - 必要に応じて手動修正                                │
│   - 承認（または却下）                                  │
└────────────────────────────────────────────────────────┘
```

### Phase 2: 矛盾検出フロー

```
┌────────────────────────────────────────────────────────┐
│ TRIGGER: 新しい観測データが追加された                   │
└────────────┬───────────────────────────────────────────┘
             │
             ▼
┌────────────────────────────────────────────────────────┐
│ CONFLICT DETECTOR                                       │
├────────────────────────────────────────────────────────┤
│                                                        │
│  Step 1: 同一フィールドの収集                          │
│    SELECT * FROM observations                          │
│    WHERE case_id = ? AND field = ?                     │
│    GROUP BY field                                      │
│                                                        │
│  Step 2: 差異分析                                      │
│    FOR each field with multiple values:                │
│      - 値の差異率を計算                                │
│      - 時点の違いを確認                                │
│      - ソースの優先度を確認                            │
│                                                        │
│  Step 3: 矛盾判定                                      │
│    IF 差異 < 10%:                                      │
│      → 正常範囲（矛盾なし）                            │
│    ELSE IF 10% <= 差異 < 30%:                         │
│      → 要確認（Warning）                               │
│    ELSE:                                               │
│      → 重大な矛盾（Critical）                          │
│                                                        │
│  Step 4: 自動解決試行                                  │
│    IF 時点の違いで説明可能:                            │
│      → 最新値を採用、他は履歴化                        │
│    ELSE IF 単位の違い:                                 │
│      → 単位を統一                                      │
│    ELSE IF ソース優先度が明確:                         │
│      → 優先度の高いソースを採用                        │
│    ELSE:                                               │
│      → 人間にエスカレーション                          │
│                                                        │
└────────────┬───────────────────────────────────────────┘
             │
             ├─ 自動解決 ─────────────┐
             │                        │
             │                        ▼
             │              ┌─────────────────────┐
             │              │ 解決済みとしてマーク │
             │              │ 通知（Info）        │
             │              └─────────────────────┘
             │
             └─ エスカレーション ─────┐
                                     │
                                     ▼
                           ┌──────────────────────┐
                           │ CONFLICT RECORD作成  │
                           │  - severity: critical│
                           │  - status: detected  │
                           │  - assigned_to: user │
                           └───────────┬──────────┘
                                       │
                                       ▼
                           ┌──────────────────────┐
                           │ 緊急通知送信          │
                           │  - Slack             │
                           │  - Email             │
                           │  - WebSocket         │
                           └───────────┬──────────┘
                                       │
                                       ▼
                           ┌──────────────────────┐
                           │ USER: 矛盾を解決     │
                           │  1. 値を選択         │
                           │  2. 理由を記録       │
                           │  3. 承認             │
                           └──────────────────────┘
```

### Phase 3: CONF処理フロー（承認あり）

```
┌────────────────────────────────────────────────────────┐
│ USER: Term Sheet PDFをアップロード                      │
└────────────┬───────────────────────────────────────────┘
             │
             ▼
┌────────────────────────────────────────────────────────┐
│ FILE UPLOAD HANDLER                                     │
├────────────────────────────────────────────────────────┤
│                                                        │
│  Step 1: セキュリティチェック                          │
│    ├─ ウイルススキャン                                 │
│    ├─ ファイルタイプ検証 (PDF/XLSX)                   │
│    ├─ サイズ制限チェック (< 50MB)                     │
│    └─ 結果: PASS / FAIL                               │
│                                                        │
│  Step 2: 暗号化保存                                    │
│    ├─ Cloud Storage (GCS) にアップロード              │
│    ├─ サーバーサイド暗号化 (SSE-KMS)                  │
│    ├─ ファイルメタデータをDBに記録                     │
│    └─ 署名付きURL生成 (期限付き)                      │
│                                                        │
│  Step 3: 処理ステータス更新                            │
│    UPDATE documents                                    │
│    SET processing_status = 'uploaded'                  │
│    WHERE id = ?                                        │
│                                                        │
└────────────┬───────────────────────────────────────────┘
             │
             ▼
┌────────────────────────────────────────────────────────┐
│ CONF PROCESSOR (バックグラウンドジョブ)                 │
├────────────────────────────────────────────────────────┤
│                                                        │
│  Step 1: ファイル取得                                  │
│    ├─ Cloud Storageからダウンロード                   │
│    └─ 一時的にメモリに保持                             │
│                                                        │
│  Step 2: テキスト抽出                                  │
│    IF PDF:                                             │
│      ├─ PyPDF2でテキスト抽出                           │
│      ├─ レイアウト解析                                 │
│      └─ ページ番号付きで保持                           │
│    ELSE IF XLSX:                                       │
│      ├─ SheetJSで読み込み                              │
│      └─ シート・セル構造を保持                         │
│                                                        │
│  Step 3: LLM抽出（セキュアモード）                     │
│    ├─ 全文ではなく関連部分のみをLLMに送信             │
│    │   例: "投資額"の周辺100文字                       │
│    ├─ PII自動検出・マスキング                          │
│    ├─ OpenAI API (gpt-4o) 呼び出し                    │
│    │   Prompt: Term Sheet抽出用                       │
│    │   Temperature: 0.1                               │
│    └─ 構造化されたJSON出力                             │
│                                                        │
│  Step 4: 整合性チェック                                │
│    ├─ プレ + 投資額 = ポスト                          │
│    ├─ 投資額 / ポスト = 持分 %                        │
│    ├─ 条項の論理チェック                               │
│    └─ 異常値検出                                       │
│                                                        │
│  Step 5: 一時保存（承認待ち）                          │
│    INSERT INTO temp_observations                       │
│    SET requires_approval = true                        │
│                                                        │
│  Step 6: 承認リクエスト作成                            │
│    INSERT INTO approval_requests                       │
│    SET approver = lead_partner                         │
│        urgency = 'high'                                │
│                                                        │
└────────────┬───────────────────────────────────────────┘
             │
             ▼
┌────────────────────────────────────────────────────────┐
│ 承認者に通知                                            │
│   - Slack: @lead_partner 緊急承認依頼                  │
│   - Email: 詳細リンク付き                              │
│   - WebSocket: リアルタイム通知                        │
└────────────┬───────────────────────────────────────────┘
             │
             ▼
┌────────────────────────────────────────────────────────┐
│ APPROVER: 承認画面を開く                                │
├────────────────────────────────────────────────────────┤
│                                                        │
│  表示内容:                                              │
│    - 抽出結果（テーブル形式）                          │
│    - 各項目の出典（ページ番号）                        │
│    - 信頼度スコア                                      │
│    - 整合性チェック結果                                │
│    - 元ファイルのプレビュー                            │
│                                                        │
│  アクション:                                            │
│    [ ✓ 承認 ]  [ ✏️ 修正 ]  [ ✗ 却下 ]               │
│                                                        │
└────────────┬───────────────────────────────────────────┘
             │
             ├─ 承認 ────────────────┐
             │                       │
             │                       ▼
             │            ┌──────────────────────┐
             │            │ 本番DBに反映          │
             │            │ - temp → production  │
             │            │ - approved_by設定    │
             │            │ - approved_at記録    │
             │            └──────────┬───────────┘
             │                       │
             │                       ▼
             │            ┌──────────────────────┐
             │            │ ワークフロー続行      │
             │            │ (次のフェーズへ)      │
             │            └──────────────────────┘
             │
             ├─ 修正 ────────────────┐
             │                       │
             │                       ▼
             │            ┌──────────────────────┐
             │            │ 修正内容を反映        │
             │            │ 再度承認プロセス      │
             │            └──────────────────────┘
             │
             └─ 却下 ────────────────┐
                                     │
                                     ▼
                          ┌──────────────────────┐
                          │ 却下理由を記録        │
                          │ 再処理またはスキップ  │
                          └──────────────────────┘
```

---

## 3. ユーザーインタラクションのシーケンス

### シーケンス1: 新規案件作成から初回レポート生成まで

```
User          Frontend       API          Workflow        DB        LLM       External
 │               │            │              │            │         │            │
 │ 案件作成      │            │              │            │         │            │
 ├──────────────>│            │              │            │         │            │
 │               │ POST /cases│              │            │         │            │
 │               ├───────────>│              │            │         │            │
 │               │            │ INSERT       │            │         │            │
 │               │            ├─────────────>│            │         │            │
 │               │            │              │            │         │            │
 │               │            │<─────────────┤            │         │            │
 │               │            │ case_id      │            │         │            │
 │               │            │              │            │         │            │
 │               │            │ start workflow            │         │            │
 │               │            ├─────────────>│            │         │            │
 │               │            │              │            │         │            │
 │               │<───────────┤              │            │         │            │
 │               │ 201 Created│              │            │         │            │
 │<──────────────┤            │              │            │         │            │
 │ 案件作成完了  │            │              │            │         │            │
 │               │            │              │            │         │            │
 │               │            │              │ PUB収集開始│         │            │
 │               │            │              ├───────────>│         │            │
 │               │            │              │   fetch    │         │            │
 │               │            │              │   website  │         │            │
 │               │            │              │            │         │  scrape    │
 │               │            │              │            │         ├───────────>│
 │               │            │              │            │         │<───────────┤
 │               │            │              │            │         │  HTML      │
 │               │            │              │            │         │            │
 │               │            │              │            │  extract│            │
 │               │            │              │            │<────────┤            │
 │               │            │              │            │  (LLM)  │            │
 │               │            │              │            │         │            │
 │               │            │              │   save     │         │            │
 │               │            │              │   obs      │         │            │
 │               │            │              ├───────────>│         │            │
 │               │            │              │            │         │            │
 │               │ WebSocket  │              │  progress  │         │            │
 │               │<───────────┼──────────────┤  update    │         │            │
 │<──────────────┤ 進捗通知   │              │            │         │            │
 │ "PUB収集30%" │            │              │            │         │            │
 │               │            │              │            │         │            │
 │               │            │              │ EXT収集開始│         │            │
 │               │            │              │            │         │   API call │
 │               │            │              │            │         ├───────────>│
 │               │            │              │            │         │<───────────┤
 │               │            │              │            │         │  data      │
 │               │            │              │   save     │         │            │
 │               │            │              │   obs      │         │            │
 │               │            │              ├───────────>│         │            │
 │               │            │              │            │         │            │
 │               │ WebSocket  │              │  progress  │         │            │
 │               │<───────────┼──────────────┤  update    │         │            │
 │<──────────────┤            │              │            │         │            │
 │ "EXT収集完了"│            │              │            │         │            │
 │               │            │              │            │         │            │
 │ 結果確認      │            │              │            │         │            │
 ├──────────────>│            │              │            │         │            │
 │               │ GET /obs   │              │            │         │            │
 │               ├───────────>│              │            │         │            │
 │               │            │ SELECT       │            │         │            │
 │               │            ├─────────────>│            │         │            │
 │               │            │<─────────────┤            │         │            │
 │               │<───────────┤              │            │         │            │
 │<──────────────┤ 観測データ │              │            │         │            │
 │               │            │              │            │         │            │
```

### シーケンス2: 矛盾検出と解決

```
System      ConflictDetector    DB         User        Notification
  │               │              │           │              │
  │ 新データ追加  │              │           │              │
  ├──────────────>│              │           │              │
  │               │ SELECT同一field          │              │
  │               ├─────────────>│           │              │
  │               │<─────────────┤           │              │
  │               │ 複数値あり   │           │              │
  │               │              │           │              │
  │               │ 差異分析     │           │              │
  │               │ → 30%差異    │           │              │
  │               │              │           │              │
  │               │ INSERT conflict          │              │
  │               ├─────────────>│           │              │
  │               │              │           │              │
  │               │              │           │  send alert  │
  │               │              │           │<─────────────┤
  │               │              │           │              │
  │               │              │  通知受信 │              │
  │               │              │<──────────┤              │
  │               │              │           │              │
  │               │              │  矛盾確認画面開く        │
  │               │              │───────────>              │
  │               │              │           │              │
  │               │              │  選択: 値A│              │
  │               │              │<──────────┤              │
  │               │              │           │              │
  │               │ UPDATE conflict          │              │
  │               │  status='resolved'       │              │
  │               ├─────────────>│           │              │
  │               │              │           │              │
  │               │ UPDATE obs   │           │              │
  │               │  (値Aを採用)│           │              │
  │               ├─────────────>│           │              │
  │               │              │           │              │
  │               │              │  完了通知 │              │
  │               │              │───────────>              │
  │               │              │           │              │
```

---

## 4. エラーハンドリングフロー

### LLM抽出失敗時のフォールバック

```
┌─────────────────────────────────────────────┐
│ LLM抽出実行                                  │
└──────────────┬──────────────────────────────┘
               │
               ▼
         ┌─────────┐
         │ 成功？  │
         └────┬────┘
              │
    ┌─────────┴─────────┐
    │                   │
   YES                 NO
    │                   │
    ▼                   ▼
┌────────┐      ┌────────────────┐
│ 正常終了│      │ エラー分類     │
└────────┘      └───────┬────────┘
                        │
            ┌───────────┼───────────┐
            │           │           │
            ▼           ▼           ▼
    ┌──────────┐ ┌──────────┐ ┌──────────┐
    │ Rate Limit│ │ Timeout  │ │ Invalid  │
    │           │ │          │ │ Response │
    └─────┬────┘ └─────┬────┘ └─────┬────┘
          │            │            │
          │            │            │
    ┌─────▼────────────▼────────────▼─────┐
    │ リトライ判定                         │
    │  - Rate Limit: 60秒待機してリトライ  │
    │  - Timeout: 即座にリトライ(最大3回) │
    │  - Invalid: プロンプト修正してリトライ│
    └──────────────┬──────────────────────┘
                   │
                   ▼
             ┌──────────┐
             │ リトライ │
             │ 回数確認 │
             └─────┬────┘
                   │
         ┌─────────┴─────────┐
         │                   │
      < 3回               ≥ 3回
         │                   │
         ▼                   ▼
    ┌────────┐      ┌────────────────┐
    │ 再実行 │      │ フォールバック │
    └───┬────┘      └───────┬────────┘
        │                   │
        └───────┬───────────┘
                │
                ▼
     ┌──────────────────────┐
     │ フォールバック処理    │
     ├──────────────────────┤
     │ 1. 簡易プロンプトで  │
     │    再試行             │
     │ 2. 別のLLMで試行     │
     │    (Gemini)          │
     │ 3. 手動入力タスク作成│
     │ 4. ユーザーに通知    │
     └──────────────────────┘
```

---

## 5. リアルタイム更新フロー（WebSocket）

```
Browser          WebSocket Server       Redis PubSub      Worker
  │                     │                    │              │
  │ 接続                │                    │              │
  ├────────────────────>│                    │              │
  │                     │ subscribe          │              │
  │                     │ channel:case_123   │              │
  │                     ├───────────────────>│              │
  │                     │                    │              │
  │                     │                    │  処理実行    │
  │                     │                    │<─────────────┤
  │                     │                    │              │
  │                     │                    │  publish     │
  │                     │                    │  event       │
  │                     │<───────────────────┤              │
  │                     │ {type: 'progress'} │              │
  │                     │                    │              │
  │  イベント受信       │                    │              │
  │<────────────────────┤                    │              │
  │  {                  │                    │              │
  │   type: 'progress'  │                    │              │
  │   stage: 'PUB',     │                    │              │
  │   progress: 0.6     │                    │              │
  │  }                  │                    │              │
  │                     │                    │              │
  │  UIを更新           │                    │              │
  │  ProgressBar: 60%   │                    │              │
  │                     │                    │              │
```

---

これらのフロー図により、システムの動作が明確になり、実装時の判断がスムーズになります。各フローは実装の「設計図」として機能します。

